<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manage Announcements ‚Äî Teacher</title>

  <link rel="icon" href="data:image/svg+xml,
  <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
    <text y='.9em' font-size='85'>üì£</text>
  </svg>">

  <style>
    :root {
      --accent: #007aff;
      --danger: #ff3b30;
      --card: rgba(255,255,255,0.55);
      --blur: blur(22px);
      --muted:#666;
    }

    body {
      margin:0;
      font-family:-apple-system, "Inter", sans-serif;
      background: linear-gradient(135deg,#dce7ff,#eef3ff,#ffffff);
      padding:28px 12px;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    .nav {
      width:90%; max-width:900px;
      display:flex; justify-content:space-between;
      margin-bottom:18px;
    }

    .nav h1 {
      margin:0; font-size:24px; font-weight:600;
      display:flex; gap:10px; align-items:center;
    }

    button {
      cursor:pointer;
      border:none;
      border-radius:12px;
      padding:10px 16px;
      font-weight:500;
    }

    #signOutBtn {
      background:var(--danger);
      color:white;
    }

    .card {
      width:90%; max-width:900px;
      background:var(--card);
      backdrop-filter:var(--blur);
      border-radius:18px;
      padding:20px;
      box-shadow:0 8px 30px rgba(0,0,0,0.10);
      margin-top:20px;
    }

    input, textarea {
      width:100%; font-size:16px;
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,0.15);
      margin-bottom:10px;
    }

    textarea { min-height:90px; resize:vertical; }

    .primary { background:var(--accent); color:white; }

    .ann {
      background:white;
      padding:16px;
      border-radius:12px;
      box-shadow:0 6px 20px rgba(0,0,0,0.05);
      margin-bottom:12px;
      display:flex; justify-content:space-between; gap:12px;
    }

    .ann h3 { margin:0; font-size:17px; }
    .ann p { margin:6px 0; font-size:15px; }
    .meta { font-size:13px; color:var(--muted); margin-top:6px; }

    .small-btn {
      padding:8px 12px; font-size:13px;
      border:none; border-radius:10px;
    }
    .edit { background:#fff5c2; }
    .delete { background:#ffd1d1; }

    a.home {
      margin-top:20px;
      color:var(--accent);
      text-decoration:none;
      font-weight:500;
      font-size:15px;
    }
  </style>

</head>
<body>

  <div class="nav">
    <h1>üì£ Manage Announcements</h1>
    <button id="signOutBtn">Sign Out</button>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px 0; font-size:20px;">Post New Announcement</h2>

    <input id="title" placeholder="Title">
    <textarea id="message" placeholder="Write message..."></textarea>

    <button class="primary" id="postBtn">Post Announcement</button>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px 0; font-size:20px;">All Announcements</h2>
    <div id="annList">Loading...</div>
  </div>

  <a href="index-teacher.html" class="home">‚Üê Back to Home</a>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyB3Lv_9EiVBVy5aXwiYOn0pgZu31ykFOGM",
      authDomain: "digitalbellplisworkthistime.firebaseapp.com",
      databaseURL: "https://digitalbellplisworkthistime-default-rtdb.firebaseio.com",
      projectId: "digitalbellplisworkthistime",
      storageBucket: "digitalbellplisworkthistime.firebasestorage.app",
      messagingSenderId: "829189847707",
      appId: "1:829189847707:web:99b13d5fe551b54d9ce43e"
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.database();
    const auth = firebase.auth();

    const adminUID = "lPvZ7WGuTVP1LcYvKjGYtOj1GBD3";

    auth.onAuthStateChanged(user => {
      if (!user || user.uid !== adminUID) {
        window.location.href = "index.html";
        return;
      }
    });

    document.getElementById("signOutBtn").onclick = () =>
      auth.signOut().then(() => (window.location.href = "index.html"));

    // POST ANNOUNCEMENT
    document.getElementById("postBtn").onclick = () => {
      const title = title.value.trim();
      const msg = message.value.trim();

      if (!title || !msg) return alert("Please fill all fields");

      const payload = {
        title,
        message: msg,
        timestamp: Date.now(),
        postedBy: auth.currentUser.email
      };

      db.ref("announcements").push(payload);
      title.value = "";
      message.value = "";
    };

    // LOAD ANNOUNCEMENTS ‚Äî FIXED (no recursion)
    db.ref("announcements")
      .orderByChild("timestamp")
      .on("value", snap => {
        const box = document.getElementById("annList");
        box.innerHTML = "";

        if (!snap.exists()) {
          box.innerHTML = `<div style="color:#666">No announcements.</div>`;
          return;
        }

        const arr = [];
        snap.forEach(s => arr.push({ id: s.key, ...s.val() }));
        arr.reverse();

        arr.forEach(a => {
          const div = document.createElement("div");
          div.className = "ann";

          div.innerHTML = `
            <div>
              <h3>${escapeHtml(a.title)}</h3>
              <p>${escapeHtml(a.message)}</p>
              <div class="meta">
                Posted by ${escapeHtml(a.postedBy)} ¬∑ ${new Date(a.timestamp).toLocaleString()}
              </div>
            </div>

            <div>
              <button class="small-btn edit" onclick="editAnn('${a.id}')">Edit</button>
              <button class="small-btn delete" onclick="delAnn('${a.id}')">Delete</button>
            </div>
          `;

          box.appendChild(div);
        });
      });

    function editAnn(id) {
      db.ref("announcements/" + id).once("value").then(snap => {
        const val = snap.val();
        const t = prompt("Edit title:", val.title);
        if (t === null) return;

        const m = prompt("Edit message:", val.message);
        if (m === null) return;

        db.ref("announcements/" + id).update({
          title: t,
          message: m,
          editedAt: Date.now()
        });
      });
    }

    function delAnn(id) {
      if (confirm("Delete this announcement?"))
        db.ref("announcements/" + id).remove();
    }

    function escapeHtml(t) {
      return String(t).replace(/[&<>]/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;" }[c]));
    }
  </script>

</body>
</html>
